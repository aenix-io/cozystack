{{- $cozyConfig := lookup "v1" "ConfigMap" "cozy-system" "cozystack" }}
{{- $host := index $cozyConfig.data "root-host" }}
{{- $apiServerAdress := index $cozyConfig.data "api-server-adress" }}
{{- $k8sClientSecret := lookup "v1" "Secret" "cozy-keycloak" "k8s-client" }}
{{- $k8sClient := index $k8sClientSecret.data "client-secret-key" | b64dec }}
{{- $rootSaConfigMap := lookup "v1" "ConfigMap" "kube-system" "kube-root-ca.crt" }}
{{- $k8sCa := index $rootSaConfigMap.data "ca.crt" | b64enc  }}

apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "tenant.name" . }}-dashboard-resources
  namespace: {{ .Release.namespace }}
rules:
- apiGroups:
  - ""
  resources:
  - secrets
  resourceNames:
  - kubeconfig-{{ include "tenant.name" . }}
  verbs: ["get", "list", "watch"]


---

apiVersion: v1
kind: Secret
metadata:
  name: kubeconfig-{{ include "tenant.name" . }}
  namespace: tenant-root
stringData:
  kubeconfig: |
    apiVersion: v1
    clusters:
    - cluster:
        server: https://{{ $apiServerAdress }}:6443
        certificate-authority-data: {{ $k8sCa }}
      name: cluster
    contexts:
    - context:
        cluster: cluster
        namespace: {{ include "tenant.name" . }}
        user: keycloak
      name: {{ include "tenant.name" . }}
    current-context: default
    users:
    - name: keycloak
      user:
        exec:
          apiVersion: client.authentication.k8s.io/v1beta1
          args:
          - oidc-login
          - get-token
          - --oidc-issuer-url=https://keycloak.{{ $host }}/realms/cozy
          - --oidc-client-id=kubernetes
          - --oidc-client-secret={{ $k8sClient }}
          - --skip-open-browser
          - --grant-type=password
          command: kubectl
