{{- if .Values.isolated }}
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-internal-communication
  namespace: {{ include "tenant.name" . }}
spec:
  endpointSelector: {}
  ingress:
  - fromEndpoints:
    - {}
  egress:
  - toEndpoints:
    - {}
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-external-communication
  namespace: {{ include "tenant.name" . }}
spec:
  endpointSelector: {}
  ingress:
  - fromEntities:
      - world
  egress:
  - toEntities:
      - world
---
{{- if ne (include "tenant.name" .) "tenant-root" }}
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-from-upper-tenants
  namespace: {{ include "tenant.name" . }}
spec:
  endpointSelector: {}
  ingress:
  - fromEndpoints:
    {{- if hasPrefix "tenant-" .Release.Namespace }}
    {{- $parts := splitList "-" .Release.Namespace }}
    {{- range $i, $v := $parts }}
    {{- if ne $i 0 }}
    - matchLabels:
        "k8s:io.kubernetes.pod.namespace": {{ join "-" (slice $parts 0 (add $i 1)) }}
    {{- end }}
    {{- end }}
    {{- end }}
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-to-upper-tenants
  namespace: {{ include "tenant.name" . }}
spec:
  endpointSelector: {}
  egress:
  - toEndpoints:
    {{- if hasPrefix "tenant-" .Release.Namespace }}
    {{- $parts := splitList "-" .Release.Namespace }}
    {{- range $i, $v := $parts }}
    {{- if ne $i 0 }}
    - matchLabels:
        "k8s:io.kubernetes.pod.namespace": {{ join "-" (slice $parts 0 (add $i 1)) }}
    {{- end }}
    {{- end }}
    {{- end }}
{{- end }}
---
apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: "allow-to-down-labels-{{ include "tenant.name" . }}"
spec:
  endpointSelector:
    matchLabels:
      k8s:io.kubernetes.pod.namespace: "{{ include "tenant.name" . }}"
  egress:
  - toEndpoints:
    - matchLabels:
        "k8s:io.cilium.k8s.namespace.labels.tenant.cozystack.io/{{ include "tenant.name" . }}": ""
---
{{- if .Values.etcd }}
apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: "allow-to-etcd-{{ include "tenant.name" . }}"
spec:
  endpointSelector:
    matchLabels:
      k8s:io.kubernetes.pod.namespace: "{{ include "tenant.name" . }}"
      cozystack.io/service: etcd
  ingress:
  - fromEndpoints:
    - matchLabels:
        k8s:io.cilium.k8s.namespace.labels.namespace.cozystack.io/etcd: "{{ include "tenant.name" . }}"
{{- end }}
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-to-apiserver
  namespace: {{ include "tenant.name" . }}
spec:
  endpointSelector:
    matchLabels:
      policy.cozystack.io/allow-to-apiserver: "true"
  egress:
  - toEntities:
    - kube-apiserver
  - toPorts:
    - ports:
      - port: "6443"
        protocol: TCP
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-to-dns
  namespace: {{ include "tenant.name" . }}
spec:
  endpointSelector: {}
  egress:
  - toEndpoints:
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: kube-system
        k8s-app: kube-dns
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-to-dashboard
  namespace: {{ include "tenant.name" . }}
spec:
  endpointSelector: {}
  egress:
  - toEndpoints:
      - matchLabels:
          k8s:io.kubernetes.pod.namespace: cozy-dashboard
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-to-ingress
  namespace: {{ include "tenant.name" . }}
spec:
  endpointSelector: {}
  egress:
  - toEndpoints:
    - matchLabels:
        cozystack.io/service: ingress
{{- end }}
